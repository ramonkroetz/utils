name: CI and Release

on:
  # Manual trigger for releases only
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
      custom_version:
        description: 'Custom version (e.g., 1.2.3) - leave empty to auto-increment'
        required: false
        type: string
  
  # CI triggers - run on PRs and pushes to main
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  ci-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Node.js Version with NVM
        run: |
          nvm install
          nvm use
        shell: bash -l {0}

      - name: Install Dependencies
        run: npm ci

      - name: Linter
        run: npm run lint

      - name: Tests
        run: npm test

      - name: Build
        run: npm run build

      - name: CI Summary
        run: |
          echo "=== CI Checks Completed ==="
          echo "All checks passed successfully!"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

  # Release Job - only runs on manual trigger
  release-publish:
    needs: ci-checks
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Log manual trigger info
        run: |
          echo "=== Manual Release Trigger ==="
          echo "Triggered by: ${{ github.actor }}"
          echo "Release type: ${{ github.event.inputs.release_type }}"
          echo "Custom version: ${{ github.event.inputs.custom_version }}"

      - name: Set Node.js Version with NVM
        run: |
          nvm install
          nvm use
        shell: bash -l {0}

      - name: Install Dependencies
        run: npm ci

      - name: Run CI checks before release
        run: |
          echo "Running pre-release checks..."
          npm run lint
          npm test
          npm run build
          echo "All pre-release checks passed!"

      - name: Get latest release details
        id: get-release
        run: |
          RECENT_RELEASES_ARRAY=$(curl -qsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "${{ github.api_url }}/repos/${{ github.repository }}/releases")

          RECENT_RELEASE=$(echo "$RECENT_RELEASES_ARRAY" | jq '.[0]')

          echo "TAG_NAME=$(echo "$RECENT_RELEASE" | jq -r '.tag_name')" >> $GITHUB_ENV

      - name: Determine new version
        id: version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Current latest tag: ${{ env.TAG_NAME }}"
          
          # Handle manual dispatch with custom version
          if [[ -n "${{ github.event.inputs.custom_version }}" ]]; then
            CUSTOM_VERSION="${{ github.event.inputs.custom_version }}"
            # Validate custom version format
            if [[ ! "$CUSTOM_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Error: Custom version must be in format X.Y.Z (e.g., 1.2.3)"
              exit 1
            fi
            NEW_TAG="v$CUSTOM_VERSION"
            echo "Using custom version: $NEW_TAG"
            echo "type=custom" >> $GITHUB_OUTPUT
            echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Handle manual dispatch with release type
          RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          echo "Manual release type: $RELEASE_TYPE"
          
          # Calculate new version
          if [[ -z "${{ env.TAG_NAME }}" ]] || [[ "${{ env.TAG_NAME }}" == "null" ]]; then
            # First release
            NEW_TAG="v1.0.0"
          else
            CURRENT_TAG="${{ env.TAG_NAME }}"
            # Remove 'v' prefix if present
            CURRENT_TAG="${CURRENT_TAG#v}"
            IFS='.' read -ra VERSION <<< "$CURRENT_TAG"
            
            MAJOR=${VERSION[0]}
            MINOR=${VERSION[1]}
            PATCH=${VERSION[2]}
            
            case "$RELEASE_TYPE" in
              "major")
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              "minor")
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              "patch")
                PATCH=$((PATCH + 1))
                ;;
            esac
            
            NEW_TAG="v$MAJOR.$MINOR.$PATCH"
          fi
          
          echo "New tag: $NEW_TAG"
          echo "type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          echo "tag=$NEW_TAG" >> $GITHUB_OUTPUT

      - name: Extract clean version number
        id: extract-version
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          # Remove the 'v' prefix
          CLEAN_VERSION="${TAG#v}"
          echo "RELEASE_VERSION=$CLEAN_VERSION" >> $GITHUB_ENV
          echo "clean_version=$CLEAN_VERSION" >> $GITHUB_OUTPUT
          echo "Extracted clean version: $CLEAN_VERSION"

      - name: Confirm release
        if: steps.version.outputs.tag
        run: |
          echo "========================================="
          echo "RELEASE CONFIRMATION"
          echo "========================================="
          echo "New version: ${{ steps.version.outputs.tag }}"
          echo "Release type: ${{ steps.version.outputs.type }}"
          echo "Current version: ${{ env.TAG_NAME }}"
          echo "Clean version: ${{ steps.extract-version.outputs.clean_version }}"
          echo "========================================="
          echo "This will:"
          echo "1. Create tag: ${{ steps.version.outputs.tag }}"
          echo "2. Create GitHub Release"
          echo "3. Create release branch: release/${{ steps.extract-version.outputs.clean_version }}"
          echo "========================================="

      - name: Create Git Tag
        if: steps.version.outputs.tag
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        if: steps.version.outputs.tag
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Release ${{ steps.version.outputs.tag }}"
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            **Release Type:** ${{ steps.version.outputs.type }}
            **Triggered by:** ${{ github.actor }}
            
            ---
            
            Automated release created via GitHub Actions workflow.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push release branch
        if: steps.version.outputs.tag
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"
          
          # Create release branch using the clean version
          RELEASE_VERSION="${{ steps.extract-version.outputs.clean_version }}"
          echo "Creating release branch: release/$RELEASE_VERSION"
          git checkout -b release/$RELEASE_VERSION
          
          # Update package.json version (without creating a tag)
          npm version $RELEASE_VERSION --no-git-tag-version --allow-same-version
          
          # Commit the version change
          git add package.json
          git commit -m "chore: update version to $RELEASE_VERSION"
          
          # Push to remote
          git push --set-upstream origin release/$RELEASE_VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: always()
        run: |
          echo "=== Release Summary ==="
          echo "Status: ${{ job.status }}"
          if [[ "${{ steps.version.outputs.tag }}" != "" ]]; then
            echo "‚úÖ Release created: ${{ steps.version.outputs.tag }}"
            echo "üìã Release type: ${{ steps.version.outputs.type }}"
            echo "üåø Release branch: release/${{ steps.extract-version.outputs.clean_version }}"
            echo ""
            echo "Next steps:"
            echo "1. Review the release at: https://github.com/${{ github.repository }}/releases"
            echo "2. The release branch 'release/${{ steps.extract-version.outputs.clean_version }}' has been created"
          else
            echo "‚ùå No release was created"
          fi